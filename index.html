<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title></title>
  <script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
  <script src="js/d3.min.js"></script>
  <script type="text/javascript" src="js/uikit.min.js"></script>
  <script type="text/javascript" src="js/uikit-icons.min.js"></script>
  <script type="text/javascript" src="js/d3-queue.min.js"></script>
  <script type="text/javascript" src="js/topojson.min.js"></script>
  <link type="text/css" rel="stylesheet" href="css/uikit.min.css" />

  <style type="text/css">
    .central-960 {
      min-width: 960px;
    }

    path {
      fill: lightgrey;
      stroke: #000000;
    }

    svg {
      display: inline-block;
      margin: auto 0;
      text-align: center;
    }

    /* BN's seats colour */

    .bn {
      fill: #092781;
    }

    /* PH's seats colour */

    .ph {
      fill: #ED1C24;
    }

    /* PAS' seats colour */

    .pas {
      fill: #009000;
    }

    /* Independent candidates' seats colour */

    .ind {
      fill: #E6E6E6;
    }

    /* Solidariti's seat colour */

    .solidariti {
      fill: #78D7F5;
    }
  </style>
</head>

<body>
  <div class="uk-margin-top uk-container uk-container-center uk-container-expand">
    <h2 class="uk-text-center">Title</h2>
    <div id="map" align="center"></div>
    <!-- <div id="const_chart" align="center"></div> -->
  </div>
  <script>
    var margin = 60;
    // var width = (window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth) - margin;
    // var height = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
    //
    // var width = 1400;
    // var height = 600;

    var viewportWidth = $(window).width();
    var viewportHeight = $(window).height() / 2;
    var width = viewportWidth * .90;
    var height = width / 1.85;

    var mapContainer = d3.select('#map')
      .append('svg')
      .attr('width', width)
      .attr('height', height)
      .append('g');

    var projection = d3.geoMercator()

    var path = d3.geoPath()
      .projection(projection);

    var Kod_PAR = d3.map();
    var constByKodPAR = d3.map();
    var wonCoallitionByKodPAR = d3.map();
    var winnerByKodPAR = d3.map();
    var losersByKodPAR = d3.map();
    var wonPartyByKodPAR = d3.map();

    var constName = mapContainer.append('text')
      .attr('text-anchor', 'middle')
      .attr('y', 30)
      .attr('x', (width) / 2)
      .text('');

    var wonCoallition = mapContainer.append('text')
      .attr('text-anchor', 'start')
      .attr('y', 50)
      .attr('x', (width) * 0.4)
      .text('');

    var winner = mapContainer.append('text')
      .attr('text-anchor', 'start')
      .attr('y', 70)
      .attr('x', (width) * 0.4)
      .text('');

    var loser = function(n) {
      n = n || 1;
      var extraHeight = 20 * n;
      return mapContainer.append('text')
      .classed('losers', true)
      .attr('text-anchor', 'start')
      .attr('y', extraHeight + 70)
      .attr('x', (width) * 0.4)
      .text('');
    }

    var results = {};
    d3.queue()
      .defer(d3.json, 'data/Malaysia_Parliamentary_Boundaries_2018.json')
      .defer(d3.csv, 'data/ge14.csv', function (d) {
        if (!results[d['KodPAR']]) {
          results[d['KodPAR']] = {
            winner: '',
            losers: [],
          };
        }


        // console.log(d['State']);
        constByKodPAR.set(d['KodPAR'], d['const_name']);
        wonCoallitionByKodPAR.set(d['KodPAR'], d['won_coallition']);
        wonPartyByKodPAR.set(d['KodPAR'], d['won_party']);
        
        // Only allow winner name displayed
        if (d['won_party'] === d['party']) {
          results[d['KodPAR']].winner = d['candidate_name'];
        } else {
          results[d['KodPAR']].losers.push({
            name: d['candidate_name'],
            party: d['party'],
          });
        }

        winnerByKodPAR.set(d['KodPAR'], results[d['KodPAR']]);
      })
      .await(ready);

    function ready(error, map, ge14) {
      if (error) {
        throw error;
      }

      console.log(map);
      console.log(ge14);

      setProjection(map, 'Malaysia_Parliamentary_Boundaries_2018');

      var const_map = topojson.feature(map, map.objects.Malaysia_Parliamentary_Boundaries_2018).features;

      console.log(const_map);

      mapContainer.selectAll('.constituency')
        .data(const_map)
        .enter()
        .append('path')
        // set colour for each constituency according to the winning coallition
        .attr('class', function (d) {
          if (wonCoallitionByKodPAR.get(d.properties.KodPAR) === 'PH')
            return 'ph'
          else if (wonCoallitionByKodPAR.get(d.properties.KodPAR) === 'PAS')
            return 'pas'
          else if (wonCoallitionByKodPAR.get(d.properties.KodPAR) === 'BN')
            return 'bn'
          else if (wonCoallitionByKodPAR.get(d.properties.KodPAR) === 'IND')
            return 'ind'
          else { return 'solidariti' }
        })
        .on('mouseover', function (d) {
          showInfo.call(this, d);
        })
        .on('mouseout', function (d) {
          removeInfo();
        })
        .attr('d', path);
    }

    function setProjection(map, code) {
      projection.scale(1).translate([0, 0]);
      var b = path.bounds(topojson.feature(map, map.objects[code]));
      var s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height);
      var t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];
      projection.scale(s).translate(t);
    }

    function showInfo(d) {
      constName.text(constByKodPAR.get(d.properties.KodPAR));
      var candidates = winnerByKodPAR.get(d.properties.KodPAR);
      console.log(candidates);
      winner.text('Winner: ' + candidates.winner + ' (' + wonCoallitionByKodPAR.get(d.properties.KodPAR) + ')');

      
      var losers = candidates.losers;
      losers.forEach(function(candidate, index) {
        loser(index+1).text('Loser: ' + candidate.name + ' (' + candidate.party + ')');
      });
    }

    function removeInfo() {
      constName.text('');
      winner.text('');
      mapContainer.selectAll('.losers').text('');
    }

    // responsive
    // d3.select(window).on('resize', resize);
    //
    // function resize() {
    //
    //   width = parseInt(d3.select('#map').style('width'));
    //   width = $(window).width() * .97;
    //   height = width / 1.85;
    //
    //   projection
    //     .scale([width / 3.5])
    //     .translate([width / 1, height * 1.4]);
    //
    //
    //   d3.select("#map").attr("width", width).attr("height", height);
    //   d3.select("svg").attr("width", width).attr("height", height);
    //
    //   d3.selectAll("path").attr('d', path);
    //
    //
    // }
  </script>
</body>

</html>